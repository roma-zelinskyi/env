#!/bin/bash

start_container () {
    local project_dir=$WORK_REPO
    echo "Creating container from image: $1, with name: $2"

    local volume_dir=$WORK_REPO
    local container_name=$2

    echo "Mounting $volume_dir:$volume_dir"

    if [[ $1 == *"arm64v8"* ]]; then
        container_arch=""
    else
        container_arch="--platform linux/amd64"
    fi

    docker run  -it \
    --privileged \
    $container_arch \
    --shm-size=8g \
    --net host \
    -e "WORKSPACE_FOLDER=$volume_dir" \
    -v $volume_dir:$volume_dir \
    --name $container_name \
    --workdir="$project_dir/aos" \
    $1 zsh

    echo "Done"
}

if [[ $PWD/ == $WORK_REPO/* ]]; then
    project_dir=$WORK_REPO
else
    exit 0
fi

if [[ "$1" ]]; then
    image_name="$1"
else
    image_name="arm64v8/work:latest"
fi

if [[ $image_name == *"arm64"* ]]; then
    container_name="arm64_$(basename "$project_dir")"
else
    container_name=$(basename "$project_dir")
fi

echo "Project dir: $project_dir"
echo "Container name: $container_name"

if docker ps --format '{{.Names}}' | grep -Eq "^${container_name}\$"; then
    echo "Container is started, exec zsh on container $container_name"
    docker exec -it $container_name zsh
elif docker ps -a --format '{{.Names}}' | grep -Eq "^${container_name}\$"; then
    echo "Starting contianer $container_name"
    docker start -i $container_name
else
    start_container $image_name $container_name
fi
